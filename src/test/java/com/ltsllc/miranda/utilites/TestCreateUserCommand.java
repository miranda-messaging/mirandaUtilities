package com.ltsllc.miranda.utilites;

import com.ltsllc.common.util.Utils;
import com.ltsllc.miranda.clientinterface.basicclasses.User;
import com.ltsllc.miranda.test.TestCase;
import com.ltsllc.common.commadline.CommandException;
import com.ltsllc.miranda.utilities.CreateUserCommand;
import org.junit.After;
import org.junit.Before;
import org.junit.Test;

import java.io.File;
import java.io.IOException;
import java.security.KeyPair;
import java.security.KeyStore;
import java.security.PrivateKey;
import java.security.PublicKey;

/**
 * Created by ltsllc on 7/9/2017.
 */
public class TestCreateUserCommand extends TestCase {
    private CreateUserCommand createUserCommand;

    public CreateUserCommand getCreateUserCommand() {
        return createUserCommand;
    }

    public void setCreateUserCommand(CreateUserCommand createUserCommand) {
        this.createUserCommand = createUserCommand;
    }

    @Before
    public void setup () {
        CreateUserCommand createUserCommand = new CreateUserCommand();
        setCreateUserCommand(createUserCommand);
    }


    @After
    public void ceanup () {
        deleteDirectory(TEST_DIRECTORY);
    }


    @Test
    public void testCreateKeyPair () throws Exception {
        createDirectory(TEST_DIRECTORY);
        getCreateUserCommand().setDirectory(TEST_DIRECTORY);
        KeyPair keyPair = getCreateUserCommand().createKeyPair(TEST_USER_NAME);

        assert (null != keyPair);
        assert (null != keyPair.getPrivate());
        assert (null != keyPair.getPublic());

        String filename = getCreateUserCommand().getPublicKeyFilenameFor(TEST_USER_NAME);
        File file = new File(filename);
        assert (file.exists());

        filename = getCreateUserCommand().getPrivateKeyFilenameFor(TEST_USER_NAME);
        file = new File(filename);
        assert (file.exists());
    }

    public static final String TEST_USER_NAME = "test";
    public static final String TEST_PUBLIC_KEY_FILENAME = "test/test.public.pem";

    public static final String PUBLIC_KEY = "2D2D2D2D2D424547494E205055424C4943204B45592D2D2D2D2D0D0A4D494942496A414E42676B71686B6947397730424151454641414F43415138414D49494243674B434151454171514958485339587850434D68686446315769570D0A413058695473584B57472F61374C78444E546769752B5962526E32586D6E3535475A353379684D6535587675716C4F675A6370664E315764723679793658646D0D0A6A4F4E716B3248546249524571696B307453796F475A51466C6B5A3231344A636F4D316C772B2B2F7A5775566637316932666A466E764170794A4D31536E794D0D0A303137792B7A4472533147336C45725A39783354777764625866454C614669674C71487A3669475573504967674454512F37386D452B6F5044632B44474C71500D0A2B424F6E584E6739664C433761696842774B75755A56316170365165386A58335358726E4332336361666479776E367264394C5948593330363834665861377A0D0A72674355337459613442563052334B4731397435374C7143717A51395875786C4B39354846307765526F314B6F676878786443455167526459567563773473720D0A4F514944415141420D0A2D2D2D2D2D454E44205055424C4943204B45592D2D2D2D2D0D0A";

    @Test
    public void testLoadPublicKey () throws IOException {
        createDirectory(TEST_DIRECTORY);
        getCreateUserCommand().setDirectory(TEST_DIRECTORY);
        createFile(TEST_PUBLIC_KEY_FILENAME, PUBLIC_KEY);
        pause(100);
        PublicKey publicKey = getCreateUserCommand().loadPublicKey(TEST_USER_NAME);
        assert (null != publicKey);
    }

    public static final String PRIVATE_KEY = "2D2D2D2D2D424547494E205253412050524956415445204B45592D2D2D2D2D0D0A4D4949457051494241414B43415145416E374442394C644D4963365A435A527761342F2F7465422F47355A7A4C654D72596964575836342B36764F3131727A4C0D0A6A6965773365434A78692F6158716A554F687376616E6C557376654551325A3048696A6176737A78784D584B367A304D6E6742776F59436A5A625569753041700D0A4437537873754E4246594E58643234415336744661386B5A4F68735672385430414B6E4777702B346B4231435A316B653761794949397256427476596562364A0D0A6E535649444D334D5057647148367853334D2F57786E372F6154317762714741564A665255312F637543564178352B50726D432B734D7859534F7744654875630D0A307873353672686556666474366930775A5A76526F6C48354241667657496C48795331693148317551544374634A3366557878464C65557353786E48484D66310D0A6A4C6675644C577551475456776B326A4F5A6B57447635437944484F4C6D6B47794A78444C77494441514142416F494241423845484E666B4669526D315443590D0A4A54477647564B424651384E724C6458375341325662396C76354377337A756A466349356B552B334165743964654E3231536D6F43424364476B646362644D4E0D0A666A59785A7A4D78365339333330374C58377A386875504863585561746E45364A2F2B4638424733732F64797544565A4A7A4F4C51344F49337035376A6A33430D0A656B5836733845766470422F4C6C7557597278314330677A6737612B41796C68796F5966647671476C68322B746B4C413869714E53706B424E34736B675266410D0A567A71492F63336736617039506D4D77673279665530564B67394461357163356D4577456F4E57422B2F7754316D395653304F4A4371725742797652553242540D0A6D465A34492F4E6E4D6C554B336B724143676E546D346735612F6C30365A476D4E673673696B376C4774577167337163346F505064722B7574627A6F6D306E6F0D0A306661684A4D6B4367594541366D372B473465504D485748596D42614E644A72306F46784E5934366E6D72556355494C687133634F33535276456254475334430D0A486263526959694C543355726F54634A57462F5035355A4E615046366D4D424D595346753733576F425141735778744969624A6A342B564F4D4D785330474E310D0A5371715A31322B586E574131674E705239716A4D346742356F36557761734C686841547A645A4B576259645633706A7A495A6664424D554367594541726D47490D0A732B6E5334796B4951594E5758727051456344694D6C4758586B574135356B6F7A3245614A4B55584F4B59646C65633650683267674335614A744E2B365253370D0A767068375A435658486D4475632B4672387846383859724B786D7A6579774B525A596C615876783572614A4C624B7A3665426F2F57585246383730396F53777A0D0A724853526A58582B2F506D705A3270542F4563726A77474F4536576D764B4742556A6E7162324D4367594541306D75646D59677264677548345430717533534C0D0A597637635A6E327244395A447151546D3435506151574E344338356D58417433797351753859756C7630516B545366684D336D4D57776F466F5652642F6731630D0A67544A4A4B4A59716F5A4A7550626858653443724F4472783238734A366848626A5A466A5649504E536D79346D566463696C456F3152496F48454B4247744B680D0A4B4B5A6F2F2F6237486F53444272477953557A4F4453454367594541716637354E6E4D6648455A322F753762647A4E6F4E545A31444A725031703470495234460D0A553832556E3936314F59747655694239666571422B684F3133523358486341526D71657075714A51514A513851596D6A492B324C67536C4E726F795A305179710D0A30334A49514573664436386B6D6B677A554877392F365844502B37664D733056667579517248673459554F39367377554864372F7A73533054654479482F664F0D0A5332756361494D43675945416B3564705478624458352F654F5A4F5636543053614C476C70526F6F483253436735304E4E665467516C7744514B744C385848540D0A70457634577A4C394969377A3657684F4F6258485A7942314E4E532B4C63544E2B395050387031716B6E536859716C35467531525178523762616735506F53320D0A77326630476C6D46784C376C7566474E7A7567594C614F616A6E6963784C547538657069776F6C353258646853764F2B6E52376C5077673D0D0A2D2D2D2D2D454E44205253412050524956415445204B45592D2D2D2D2D0D0A";
    public static final String TEST_PRIVATE_KEY_FILENAME = "test/test.private.pem";

    @Test
    public void testLoadPrivateKey () throws Exception {
        createDirectory(TEST_DIRECTORY);
        getCreateUserCommand().setDirectory(TEST_DIRECTORY);
        createFile(TEST_PRIVATE_KEY_FILENAME, PRIVATE_KEY);
        pause(100);
        PrivateKey privateKey = getCreateUserCommand().loadPrivateKey(TEST_USER_NAME);
        assert (null != privateKey);
    }

    public static final String TEST_KEYSTORE_FILENAME = "test/keystore";
    public static final String TEST_KEYSTORE_PASSWORD = "whatever";
    public static final String TEST_USER_FILE_FILENAME = "test/users.json";

    @Test
    public void testGoSuccess () throws Exception {
        createTestFiles();
        getCreateUserCommand().setDirectory(TEST_DIRECTORY);
        getCreateUserCommand().setKeystoreFilename(TEST_KEYSTORE_FILENAME);
        getCreateUserCommand().setKeystorePasswod(TEST_KEYSTORE_PASSWORD);
        getCreateUserCommand().setPublicKeyFilename(TEST_PUBLIC_KEY_FILENAME);
        getCreateUserCommand().setUserDescription("a test");
        getCreateUserCommand().setUserFileFilename(TEST_USER_FILE_FILENAME);
        getCreateUserCommand().setUserName(TEST_USER_NAME);
        getCreateUserCommand().setUserType(User.UserTypes.Publisher);

        getCreateUserCommand().go();

        KeyStore keyStore = Utils.loadKeyStore(TEST_KEYSTORE_FILENAME, TEST_KEYSTORE_PASSWORD);
        PrivateKey jsPrivateKey = (PrivateKey) keyStore.getKey("private", TEST_KEYSTORE_PASSWORD.toCharArray());
        com.ltsllc.miranda.clientinterface.basicclasses.PrivateKey privateKey = new com.ltsllc.miranda.clientinterface.basicclasses.PrivateKey(jsPrivateKey);
        UsersFileTest usersFileTest = new UsersFileTest(TEST_USER_FILE_FILENAME, TEST_KEYSTORE_FILENAME, TEST_KEYSTORE_PASSWORD);
        usersFileTest.load();
        assert (usersFileTest.contains (TEST_USER_NAME));
    }

    public static final String KEYSTORE = "FEEDFEED000000020000000200000002000263610000015C613401C30005582E353039000003643082036030820248A003020102020900951A1546B7E95ABF300D06092A864886F70D01010B05003045310B30090603550406130241553113301106035504080C0A536F6D652D53746174653121301F060355040A0C18496E7465726E6574205769646769747320507479204C7464301E170D3137303531383136333835385A170D3138303531383136333835385A3045310B30090603550406130241553113301106035504080C0A536F6D652D53746174653121301F060355040A0C18496E7465726E6574205769646769747320507479204C746430820122300D06092A864886F70D01010105000382010F003082010A0282010100D1B02C7DFFF1CE31C7E97C7E6629ED959255738B9B2A77DE5BA006BC586DFC6CA0F203E27A8BF9486412B45D5162703C9118E9A904F7FBFB1D5FAEE59CEADCD8E574B5E84B59CDCC12A57DAFF38066EB67DCA5503EB46841157A7C6FD43E1D535ACEEA76188463D8FBE086F6C92C83DB3B822C3A1FA88356A64C98DEF8532EA00F7ED6FD0DB14EC02F50C4D3151FE63E7D3D0D260E5318A5D3F2696906240CA3BC5A1EB10B3F66D7017080950FFFC99BDF38C564D877E51F7B01AC69BC48459B307D1DE1F951F4DE39D3C39117E448A9C9F9D7E940428729603F7C9664B169B246D7C3B9681F807EB2C0ED85AF5ADFD59E097D7B4A371F777465B7283C7C29D50203010001A3533051301D0603551D0E041604141F3008D3090510954EDFAC4949AA240CA1A801C7301F0603551D230418301680141F3008D3090510954EDFAC4949AA240CA1A801C7300F0603551D130101FF040530030101FF300D06092A864886F70D01010B0500038201010040B331E7A9214ECB5C79F70C746C75DCF8BEDF0F36B963396E9145FAFCA9308CAE82FF15F6072E9AB57C5A5C9058E9B1C7CD5FB014F9DB4C67470DF32D50B1B9B2AF5C8DCD5E84DC3BE7D328019447E538B24AC58589D2717A2FB9CB2768E06266381CC072C544D260BE89DB803A4D3DE31CCA8C34E3A944C385FCC9B6EE06B1D6904F1346BC131F1B31A192C1A12BE3409739251851F8770792DC7421F81DEEF24E2E7C8FD63075E769C8B8352B0F9AB04920EDEA4BBD6B7CEB61F3DE3E17C93422809D7143D88F6F56ADAB440C3F3B6473015DCB922B617D823C301F036F4478AAC0FB690A615CEA4D77F0863AE880C48DBB0319067DCECD43E12BC6C92FA4000000010007707269766174650000015C61343B0D0000050430820500300E060A2B060104012A021101010500048204EC8845F9D863C9C0A6ADFA8E9A734BF70A15D74A4D1F80B2C3D327DD1B3E1BA41BBE91D9BDAD1A81EABE1E121F024F377691096BBCEDD5BB5ED20EFE0FEF3E8098C54C08E64051BA94BB8D0855E2B89A92B0D165E51245C201CCB3AF2192B6BBFFDBE3913360DB8A48DC90677D445E93A5DCFB583E69EE9DBB07554E65B75267C807B1DE67D9F820A333F2FF599C081E0D25A8DBEEB856CA9505F9B3C0F502573042AD0544AA07E4ECE85A01CDA9CF93C62AB9DB02EDC6C9D92D48DB0C3BACFD47DACCEBED3B428B6C01BCD4682DA1DEB469E98F6FC1042F8590DE060BDE73EFDC8360564B7A58346858627881149D843FCD31DF53401CE3C6F86BF9E8F58F2001D0C71E79C34E26703E437C4CDD06F473EF9813F7CB6099E320670C3E43910760AAD1042C0B40EAC8F29D1B9BBD599A1F4F9013D023217F2D4D535F2B22E2F021512DE49FA912595087018BF3D4B7F436131AB13C82900BEC4B980FE620FB81722402BF62D7E7F705C79B713E0DB2224A21EFF5078CE13247EC74160366F54D113453FAAF8EFC4225E94149171AF123285C8673F3189F9B712E08FE2316B4860E46BB1ECC13FEC07C74F1CA7B9653C5A4B38F1CC654A9767CA68E765DE8DEBD0EEB2159017D8F9D27FD0BC085BFCC1238A4D26946B560DA75A2F086C60A221C0B151DF64DC1732F1205DA98ED24CFF11B7089C199865F6709B86FE8AF8E00B97BDE15462F475A773D290C10DBC2852BB5C0772E29DF6DCB48E87149518F3A940DA4BEBA98BF34DB35CAF666ED8CD7D65CE0AADB46F39BB230EDB8C3576C13FD3895C62E304D4C233A5217FC2AF98263C09B1754B71CFF9991AF5014381CB71E2F1B2CAB631745CD555F2D7C5526AF5CC35238343627977EFAC7F85047B70184ECD250BB111053C3246920F3C0B73F132452745B01494900EAD8E0E3BD4DF04C4443F6725BCD55E498EA7B5531E6E763027BBC5A2113994729DD7C8BAD1C75D77ACCFD44D113957123724BB69C729550BA13B374C3E53F45AF3AA76E836558A8A903CDDBF7AC469ABB5A3FCF3DC60BFDF92AEA2F1DCF6149A4C479EBF6DB0854A0BB3ABC57A0433B70CFE1F35531B6D9FF1EB22330CDD5FAC7577B233261DCDF7C3421174B7B53718125430CF089276F64236F149BA0213906C28F1E19D3205C976A9C8857F317A96B8CA328E823D42D6C322334B83216DCC0433A560C148E936F5F088120DB11E7E34F6A829F003E0D6FE6747EEB7D648EE8987A25183FB1019343E827D5DA87923529FE6E29A62A6E81704C1869C9BA272659F8EFE7A2589CE07E393CB6E1B27E9ABB451F09CA34EDA1EA0F09E1CB7A5AD009688291C240845174D8EB18FE3845A7D398DD1EA3518C34A5C01ED708DA440538369BE23A280816FA902839E349EA27449FCEA0C9EEE3A937AE2FFBDC67E71FF0329C0D15F004A2536BF2EA31E52B0000DCCB16DE38AE02C09035A041E42A1236450B54676BC6CC294E8FE6F9FDA44AAC077A19B09870AB02F4C397D99553C892E65F9AC03FA5DD044E7C022F013A2DAA5E6C0BF6F4D739AB45D0DED201A4823B17862DF361C422776A081F2D05E55377010822CB78E28095C2B782FF5BE4FBD42B9AF4877B7FC01B66834D50888BD069ED8BA03DCD67CB598E6A23CA315099B90E1F19D47991CFDED5ED7B1AB5C3CA4A5EF54D0BD76E685CB38208E3A6612F147DCF4DDACC1197DD763FDE134AEF92F30AD57D25058C273B8558A1F9716F97E7414272AD38E1C22CF00FB1E88EE69FF9EAD72F000000020005582E353039000003313082032D30820215020900EAF78ECEAFD426CD300D06092A864886F70D01010B05003045310B30090603550406130241553113301106035504080C0A536F6D652D53746174653121301F060355040A0C18496E7465726E6574205769646769747320507479204C7464301E170D3137303630313031303935355A170D3138303630313031303935355A306C3110300E06035504061307556E6B6E6F776E3110300E06035504081307556E6B6E6F776E3110300E06035504071307556E6B6E6F776E3110300E060355040A1307556E6B6E6F776E3110300E060355040B1307556E6B6E6F776E3110300E06035504031307556E6B6E6F776E30820122300D06092A864886F70D01010105000382010F003082010A0282010100C8B8422EDA69ED33BA67E98B1C19F9DCE9EB587F2DFCEA4B08DD5B2EEBBD07A549D34D39BB6C348F9131DC5B012F8CEA46C55C14EA82BBF7BC1899CB583860D74D40B097F4CB9D237652C18A17F2B2979E45F045884A2E74202147E9ECF18F74B4FF0056191E7B4682E96B0019F18643D311EBCB90EBEAAD9A68362CF5345434C0C7750E1D3B83E56E6E58E88BD79802A5E23CE9247207D98A6AF7C748C8122565B5E04E53FB7B3B5FB14E8ABB85D522072F08B3CA0C15378045C9C184C7F02CDAA4D8294EF6BC3FBEBFFB291F8E3DB951D5F237B4A873B7B7AD3228E56D4F09D9557C79FC94BEB94EB7231D0BD027A3107AEA95C6FB9BDE2E256DB2B33B73FD0203010001300D06092A864886F70D01010B0500038201010028A2EB10E163B4CF5C4525E09EF7BFFEF73B1DFD2451FC07E58687645F0FD5E05B8EC1F4754FC8682958828F307859E84AFFDF296805518AE90B3A7A7A22AF8C641EF5963D2EF56BAEB74930F3AD4D2867FB2E1FB90ACB929C73BC76236A2485A91F5507F9C27AAEE26F481A1BBF44DEDDDCBF37DE411E0F80913CA4B5A0BD0ACA3105C282EB3F4D0B9CA3B3977299D970576028E7D58DAF532EADB1EE42B763058B5412DBBF60EFBF65159462E13D438167A3C076C842EC907787F7B4CD2303AF0AC3A92F60B0475443F17CA98DB55EB65211C0FA37A5CB341B83C1729E958E46F4001C82D7B2DDF9535688F96CEDA8D8201CB02E560B16958622CBBC4C54420005582E353039000003643082036030820248A003020102020900951A1546B7E95ABF300D06092A864886F70D01010B05003045310B30090603550406130241553113301106035504080C0A536F6D652D53746174653121301F060355040A0C18496E7465726E6574205769646769747320507479204C7464301E170D3137303531383136333835385A170D3138303531383136333835385A3045310B30090603550406130241553113301106035504080C0A536F6D652D53746174653121301F060355040A0C18496E7465726E6574205769646769747320507479204C746430820122300D06092A864886F70D01010105000382010F003082010A0282010100D1B02C7DFFF1CE31C7E97C7E6629ED959255738B9B2A77DE5BA006BC586DFC6CA0F203E27A8BF9486412B45D5162703C9118E9A904F7FBFB1D5FAEE59CEADCD8E574B5E84B59CDCC12A57DAFF38066EB67DCA5503EB46841157A7C6FD43E1D535ACEEA76188463D8FBE086F6C92C83DB3B822C3A1FA88356A64C98DEF8532EA00F7ED6FD0DB14EC02F50C4D3151FE63E7D3D0D260E5318A5D3F2696906240CA3BC5A1EB10B3F66D7017080950FFFC99BDF38C564D877E51F7B01AC69BC48459B307D1DE1F951F4DE39D3C39117E448A9C9F9D7E940428729603F7C9664B169B246D7C3B9681F807EB2C0ED85AF5ADFD59E097D7B4A371F777465B7283C7C29D50203010001A3533051301D0603551D0E041604141F3008D3090510954EDFAC4949AA240CA1A801C7301F0603551D230418301680141F3008D3090510954EDFAC4949AA240CA1A801C7300F0603551D130101FF040530030101FF300D06092A864886F70D01010B0500038201010040B331E7A9214ECB5C79F70C746C75DCF8BEDF0F36B963396E9145FAFCA9308CAE82FF15F6072E9AB57C5A5C9058E9B1C7CD5FB014F9DB4C67470DF32D50B1B9B2AF5C8DCD5E84DC3BE7D328019447E538B24AC58589D2717A2FB9CB2768E06266381CC072C544D260BE89DB803A4D3DE31CCA8C34E3A944C385FCC9B6EE06B1D6904F1346BC131F1B31A192C1A12BE3409739251851F8770792DC7421F81DEEF24E2E7C8FD63075E769C8B8352B0F9AB04920EDEA4BBD6B7CEB61F3DE3E17C93422809D7143D88F6F56ADAB440C3F3B6473015DCB922B617D823C301F036F4478AAC0FB690A615CEA4D77F0863AE880C48DBB0319067DCECD43E12BC6C92FA4415AE9B442E73B833EC43B86FC4322BFB468B749";
    public static final String USERS_FILE = "7B226B6579223A224238444246363742323333343931303635374536463332373731444538364231443831363838423432303433383132383833303444373041373439323245453231324344354542363941394334454233444532344231344235464543393343383431363843333942323544453338413034454332313335454334303439434130344246304634344642453833374446443837443730303435364134363542344634333637333330343941353544383044314331463346394442323546343946314146324536373033303843413134363546433734324436453335413932453843434342353837313832394535354130313937434635454236444331384130443037443545363741384638373237383142344238354545364645414634364237394637303242334543383144373746433434394132463839343544323045333143394142454646364431333444464236434433393332333531433230344543363043454543353039354436363332463045413335324331433637423045363746434146353141433031393836454436343643373333313438383831444435433745383735414644334437383334394242303645454232333146364646373035303637353746353934333933423830313943343739413642424339463445373839303646443043383842353241323332433746443546384132343832353933363434222C226D657373616765223A2237343637453246463233454439433043324433423942304136413137444134364435393438443536303239333434324637363030303639373934413642313737433346423038374337333544444533313946354336464639334538364533303137433644373931343338303442423233393232394145313544424335444439373442413542343441374431413532313045344135383031423938423542354232423131434642343635433834343136383331304638433445343533303739454438453830304232443132353644393742363931333446343637433636453646384636343133313133394641313630393642393538373538414343393946354537333136304236364630363839344635433037423746463939423630373145324539374131424346443530334235463535333138324330303438463743364644363941454336313345453036323939323839303331413244393342433136443334393638374442363330433337414441363430323038303241464333343934463230424434433134363037374141303435384431433442413841453934454545453332374538443334413942453236353535434239303546413333394243373743313544423831383346423537364531384631443545394338453039334332463342384645374443433936373236364241413236384335433234324636313734434642343044313846343435323033384241443137304537463038384342354245364231414242314643464330374233464230423345444535334338433141373238353744373031393743333337434136344343463243463141413244463841304242303145333141423142363234463733383132453239423631383238463136444145424438443443383433323831303939444238453738324435413739424532334334433833344233394233324331343634454433384638323933303434303737353642333838333642443744323936443843423531453041323432314635393146374532313437384143303639434346313235373441413238334441423734453838434638423545384134423842354246453344384143363845444543314243303831373530374133434543333644414238384137393235324142443939334532444534423642373045343930334239344632384142333644423341464636344544344542384232343537303446354434323844413142463243373531423141433831444236443237463234313533384437413443323242423142313738323038313337314139333138323042313941303138384430364441344441453534353339414539433446413737443144423041343645423738324436443244393133394345454638323344443537354441323138344334423142363642324639373944414333413633444236323546443643453035463633354538454634434333313531303939423632423535343044374633353837394437313137373035363845383030423244313235364439374236393133344634363743363645364638333436434132413739423446393039314644384539333630373735373530393137383541343837464242443441343737323832373943314537423138424646344337443933414137363546463837373743313346304237343831353742424443227D";
    public static final String TEST_DIRECTORY = "test";


    public void createTestFiles () throws Exception {
        createDirectory(TEST_DIRECTORY);
        createFile(TEST_USER_FILE_FILENAME, USERS_FILE);
        createFile(TEST_KEYSTORE_FILENAME, KEYSTORE);
        createFile(TEST_PUBLIC_KEY_FILENAME, PUBLIC_KEY);
        createFile(TEST_PRIVATE_KEY_FILENAME, PRIVATE_KEY);
    }

    public void setupTest () throws Exception {
        createTestFiles();

        getCreateUserCommand().setDirectory(TEST_DIRECTORY);
        getCreateUserCommand().setKeystoreFilename(TEST_KEYSTORE_FILENAME);
        getCreateUserCommand().setKeystorePasswod(TEST_KEYSTORE_PASSWORD);
        getCreateUserCommand().setPublicKeyFilename(TEST_PUBLIC_KEY_FILENAME);
        getCreateUserCommand().setUserDescription("a test");
        getCreateUserCommand().setUserFileFilename(TEST_USER_FILE_FILENAME);
        getCreateUserCommand().setUserName(TEST_USER_NAME);
        getCreateUserCommand().setUserType(User.UserTypes.Publisher);
    }

    @Test
    public void testGoNoKeystore () throws Exception {
        setupTest();

        getCreateUserCommand().setKeystoreFilename("wrong");

        doFailureTest();
    }

    public void doFailureTest () throws Exception {
        CommandException e = null;

        try {
            getCreateUserCommand().go();
        } catch (CommandException ce) {
            e = ce;
        }

        assert (e != null);

        UsersFileTest usersFileTest = new UsersFileTest(TEST_USER_FILE_FILENAME, TEST_KEYSTORE_FILENAME, TEST_KEYSTORE_PASSWORD);
        assert (!usersFileTest.contains(TEST_USER_NAME));
    }

    @Test
    public void testGoWrongPassword () throws Exception {
        setupTest();

        getCreateUserCommand().setKeystorePasswod("wrong");

        doFailureTest();
    }

    @Test
    public void testGoInvalidUserType () throws Exception {
        setupTest();

        getCreateUserCommand().setUserType(User.UserTypes.Unknown);

        doFailureTest();
    }

    @Test
    public void testNullDirectory () throws Exception {
        setupTest();

        getCreateUserCommand().setDirectory(null);

        doFailureTest();
    }

    @Test
    public void testNeedToCreateKeyPair () {
        getCreateUserCommand().setDirectory(TEST_DIRECTORY);

        //
        // neither the public or private key exists --- we need to create a key pair
        //
        deleteDirectory(TEST_DIRECTORY);
        assert (getCreateUserCommand().needToCreateKeyPair(TEST_USER_NAME));

        //
        // the private key file is missing --- we need to create a key pair
        //
        createDirectory(TEST_DIRECTORY);
        createFile(TEST_PUBLIC_KEY_FILENAME, PUBLIC_KEY);

        assert (getCreateUserCommand().needToCreateKeyPair(TEST_USER_NAME));

        //
        // the private key file is missing --- we need to create a key pair
        //
        deleteFile(TEST_PUBLIC_KEY_FILENAME);
        createFile(TEST_PRIVATE_KEY_FILENAME, PRIVATE_KEY);

        assert (getCreateUserCommand().needToCreateKeyPair(TEST_USER_NAME));

        //
        // the public & private key files are present --- we don't need to create a key pair
        //
        createFile(TEST_PUBLIC_KEY_FILENAME, PUBLIC_KEY);

        assert (!getCreateUserCommand().needToCreateKeyPair(TEST_USER_NAME));
    }

    public static final User.UserTypes TEST_USER_TYPE = User.UserTypes.Publisher;
    public static final String TEST_USER_DESCRIPTION = "a test user";

    @Test
    public void testCreateUser () throws Exception {
        createDirectory(TEST_DIRECTORY);
        getCreateUserCommand().setDirectory(TEST_DIRECTORY);
        createFile(TEST_PUBLIC_KEY_FILENAME, PUBLIC_KEY);
        java.security.PublicKey jsPublicKey = getCreateUserCommand().loadPublicKey(TEST_USER_NAME);
        com.ltsllc.miranda.clientinterface.basicclasses.PublicKey publicKey =
                new com.ltsllc.miranda.clientinterface.basicclasses.PublicKey(jsPublicKey);

        User user = getCreateUserCommand().createUser(TEST_USER_NAME, TEST_USER_TYPE, TEST_USER_DESCRIPTION, publicKey);

        assert (user.getName().equals(TEST_USER_NAME));
        assert (user.getCategory() == User.UserTypes.Publisher);
        assert (user.getDescription().equals(TEST_USER_DESCRIPTION));
        assert (user.getPublicKey() == publicKey);
    }

    public void performCheckFailure () {
        CommandException ce = null;

        try {
            getCreateUserCommand().check();
        } catch (CommandException e) {
            ce = e;
        }

        assert (ce != null);
    }

    @Test
    public void testCheck () {
        //
        // null directory
        //
        performCheckFailure();

        //
        // directory does not exist
        //
        getCreateUserCommand().setDirectory("does not exist");
        performCheckFailure();

        //
        // directory is not a directory
        //
        createDirectory(TEST_DIRECTORY);
        createFile(TEST_PUBLIC_KEY_FILENAME, PUBLIC_KEY);
        getCreateUserCommand().setDirectory(TEST_PUBLIC_KEY_FILENAME);
        performCheckFailure();

        getCreateUserCommand().setDirectory(TEST_DIRECTORY);

        //
        // null keystore
        //
        performCheckFailure();

        //
        // keystore does not exist
        //
        getCreateUserCommand().setPublicKeyFilename("does not exist");
        performCheckFailure();

        getCreateUserCommand().setKeystoreFilename(TEST_KEYSTORE_FILENAME);
        createFile(TEST_KEYSTORE_FILENAME, KEYSTORE);

        //
        // null user name
        //
        performCheckFailure();

        getCreateUserCommand().setUserName(TEST_USER_NAME);

        //
        // invalid user type
        //
        getCreateUserCommand().setUserType(User.UserTypes.Unknown);
        performCheckFailure();

        getCreateUserCommand().setUserType(User.UserTypes.Publisher);

        //
        // null users file
        //
        performCheckFailure();

        //
        // users file does not exist
        //
        getCreateUserCommand().setUserFileFilename("does not exist");
        performCheckFailure();

        createFile(TEST_USER_FILE_FILENAME, USERS_FILE);
        getCreateUserCommand().setUserFileFilename(TEST_USER_FILE_FILENAME);

        //
        // success
        //
        CommandException ce = null;

        try {
            getCreateUserCommand().check();
        } catch (CommandException e) {
            ce = e;
        }

        assert (ce == null);
    }

}
